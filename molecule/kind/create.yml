# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- hosts: localhost
  connection: local
  no_log: "{{ molecule_no_log }}"
  vars:
    scenario_directory: "{{ lookup('env', 'MOLECULE_SCENARIO_DIRECTORY') }}"
    kind_cluster_name: "{{ lookup('env', 'KIND_CLUSTER_NAME') | default('molecule', True) }}"
  tasks:
    - name: Create KinD cluster
      ansible.builtin.command: kind create cluster --name {{ kind_cluster_name }} --config {{ scenario_directory }}/kind/config.yml

    - name: Generate instance configuration file
      ansible.builtin.copy:
        content: "{{ instance_config | to_nice_yaml }}"
        dest: "{{ molecule_instance_config }}"
      vars:
        instance_config:
          - instance: "{{ kind_cluster_name }}-control-plane"
            user: root
            address: "{{ kind_cluster_name }}-control-plane"
            connection: docker

    - name: Define IP address for the host
      ansible.builtin.set_fact:
        node_ip: "{{ ansible_default_ipv4['address'] }}"

- import_playbook: vexxhost.atmosphere.generate_workspace
  vars:
    workspace_path: "{{ lookup('env', 'MOLECULE_SCENARIO_DIRECTORY') }}"
    domain_name: "{{ node_ip.replace('.', '-') }}.{{ lookup('env', 'ATMOSPHERE_DNS_SUFFIX_NAME') | default('nip.io', True) }}"
