- nodeset:
    name: atmosphere-ubuntu-jammy-single-node
    nodes:
      - name: instance
        label: ubuntu-jammy
    groups: &single_node_groups
      - name: controllers
        nodes:
          - instance
      - name: cephs
        nodes:
          - instance
      - name: computes
        nodes:
          - instance

- nodeset:
    name: atmosphere-ubuntu-jammy-single-node-16
    nodes:
      - name: instance
        label: ubuntu-jammy-16
    groups: *single_node_groups

- job:
    name: atmosphere-molecule
    parent: molecule
    abstract: true
    nodeset: atmosphere-ubuntu-jammy-single-node
    pre-run: test-playbooks/molecule/pre.yml
    post-run: test-playbooks/molecule/post.yml
    roles:
      - zuul: opendev.org/openstack/openstack-helm
    vars:
      ceph_fsid: 4837cbf8-4f90-4300-b3f6-726c9b9f89b4
      ceph_conf_overrides:
        - section: global
          option: mon allow pool size one
          value: true
        - section: global
          option: osd crush chooseleaf type
          value: 0
        - section: mon
          option: auth allow insecure global id reclaim
          value: false
      ceph_osd_devices:
        - "/dev/ceph-{{ inventory_hostname_short }}-osd0/data"
        - "/dev/ceph-{{ inventory_hostname_short }}-osd1/data"
        - "/dev/ceph-{{ inventory_hostname_short }}-osd2/data"
      kube_vip_interface: "{{ ansible_facts['default_ipv4'].interface }}"
      kube_vip_address: 172.17.0.100
      kubernetes_hostname: "{{ ansible_facts['default_ipv4'].address }}"
      cilium_ipv4_cidr: 172.24.0.0/16
      cilium_helm_values:
        operator:
          replicas: 1
      ceph_csi_rbd_helm_values:
        provisioner:
          replicaCount: 1

- job:
    name: atmosphere-molecule-csi
    parent: atmosphere-molecule
    abstract: true
    vars:
      molecule_scenario: csi

- job:
    name: atmosphere-molecule-csi-local-path-provisioner
    parent: atmosphere-molecule-csi
    vars:
      csi_driver: local-path-provisioner

- job:
    name: atmosphere-molecule-csi-rbd
    parent: atmosphere-molecule-csi
    vars:
      csi_driver: rbd

- job:
    name: atmosphere-molecule-aio
    parent: atmosphere-molecule
    abstract: true
    timeout: 7200
    nodeset: atmosphere-ubuntu-jammy-single-node-16
    vars:
      molecule_scenario: aio
      ceph_version: 18.2.7
      kubernetes_keepalived_interface: br-mgmt
      csi_driver: local-path-provisioner
      cluster_issuer_type: self-signed
      valkey_helm_values:
        replica:
          replicaCount: 1
      ingress_nginx_helm_values:
        controller:
          config:
            worker-processes: 2
      percona_xtradb_cluster_spec:
        allowUnsafeConfigurations: true
        pxc:
          size: 1
        haproxy:
          size: 1
      keystone_helm_values:
        pod:
          replicas:
            api: 1
      barbican_helm_values:
        pod:
          replicas:
            api: 1
      rook_ceph_cluster_radosgw_spec:
        metadataPool:
          failureDomain: osd
        dataPool:
          failureDomain: osd
        gateway:
          instances: 1
      glance_helm_values:
        conf:
          glance:
            DEFAULT:
              workers: 2
            glance_store:
              rbd_store_replication: 1
        pod:
          replicas:
            api: 1
      glance_images:
        - name: cirros
          url: http://download.cirros-cloud.net/0.6.2/cirros-0.6.2-x86_64-disk.img
          min_disk: 1
          disk_format: raw
          container_format: bare
          is_public: true
      staffeln_helm_values:
        pod:
          replicas:
            api: 1
            conductor: 1
      cinder_helm_values:
        conf:
          ceph:
            pools:
              backup:
                replication: 1
              cinder.volumes:
                replication: 1
          cinder:
            DEFAULT:
              osapi_volume_workers: 2
        pod:
          replicas:
            api: 1
            scheduler: 1
      placement_helm_values:
        conf:
          placement_api_uwsgi:
            uwsgi:
              processes: 2
        pod:
          replicas:
            api: 1
      ovn_helm_values:
        conf:
          auto_bridge_add:
            br-ex: null
        pod:
          replicas:
            ovn_ovsdb_nb: 1
            ovn_ovsdb_sb: 1
            ovn_northd: 1
      coredns_helm_values:
        replicaCount: 1
      nova_helm_values:
        conf:
          nova:
            DEFAULT:
              osapi_compute_workers: 2
              metadata_workers: 2
            conductor:
              workers: 2
            scheduler:
              workers: 2
        pod:
          replicas:
            api_metadata: 1
            osapi: 1
            conductor: 1
            scheduler: 1
            novncproxy: 1
            spiceproxy: 1
      neutron_helm_values:
        conf:
          neutron:
            DEFAULT:
              api_workers: 2
              rpc_workers: 2
              metadata_workers: 2
        pod:
          replicas:
            server: 1
            rpc_server: 1
      heat_helm_values:
        conf:
          heat:
            DEFAULT:
              num_engine_workers: 2
            heat_api:
              workers: 2
            heat_api_cfn:
              workers: 2
            heat_api_cloudwatch:
              workers: 2
        pod:
          replicas:
            api: 1
            cfn: 1
            cloudwatch: 1
            engine: 1
      octavia_helm_values:
        conf:
          octavia:
            controller_worker:
              workers: 2
          octavia_api_uwsgi:
            uwsgi:
              processes: 2
        pod:
          replicas:
            api: 1
            worker: 1
            housekeeping: 1
      magnum_helm_values:
        conf:
          magnum:
            api:
              workers: 2
            conductor:
              workers: 2
        pod:
          replicas:
            api: 1
            conductor: 1
      magnum_image_disk_format: qcow2
      magnum_images: "[ {{ _magnum_images[-1] }} ]"
      manila_helm_values:
        conf:
          manila:
            DEFAULT:
              osapi_share_workers: 2
        pod:
          replicas:
            api: 1
            scheduler: 1
      horizon_helm_values:
        pod:
          replicas:
            server: 1

- job:
    name: atmosphere-molecule-aio-openvswitch
    parent: atmosphere-molecule-aio
    vars:
      atmosphere_network_backend: openvswitch

- job:
    name: atmosphere-molecule-aio-ovn
    parent: atmosphere-molecule-aio
    vars:
      atmosphere_network_backend: ovn

- project:
    check:
      jobs:
        - atmosphere-molecule-aio-openvswitch
        - atmosphere-molecule-aio-ovn
        - atmosphere-molecule-csi-local-path-provisioner
        - atmosphere-molecule-csi-rbd
    gate:
      jobs:
        - atmosphere-molecule-aio-openvswitch
        - atmosphere-molecule-aio-ovn
        - atmosphere-molecule-csi-local-path-provisioner
        - atmosphere-molecule-csi-rbd
