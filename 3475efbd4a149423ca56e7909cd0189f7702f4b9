{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "0921ae87_33580854",
        "filename": "charts/ovn/templates/statefulset-ovsdb-nb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 106,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Do we even need this?  ovsdb is just a db server, it should not need to interact with openvswitch, I think we should try and limit the interactions there.",
      "range": {
        "startLine": 105,
        "startChar": 0,
        "endLine": 106,
        "endChar": 45
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "19bf2be4_95760fe4",
        "filename": "charts/ovn/templates/statefulset-ovsdb-nb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 106,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2025-01-17T01:44:17Z",
      "side": 1,
      "message": "Oh yeah, you are right, it\u0027s not necessary.",
      "parentUuid": "0921ae87_33580854",
      "range": {
        "startLine": 105,
        "startChar": 0,
        "endLine": 106,
        "endChar": 45
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c55a30ed_196a1373",
        "filename": "charts/ovn/templates/statefulset-ovsdb-nb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 106,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-17T01:57:53Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "19bf2be4_95760fe4",
      "range": {
        "startLine": 105,
        "startChar": 0,
        "endLine": 106,
        "endChar": 45
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e840dd19_9873bdb8",
        "filename": "charts/ovn/templates/statefulset-ovsdb-nb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 115,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "We would then remove this.",
      "range": {
        "startLine": 112,
        "startChar": 0,
        "endLine": 115,
        "endChar": 35
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73953e32_fd967bc7",
        "filename": "charts/ovn/templates/statefulset-ovsdb-nb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 119,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Same thing here, I don\u0027t think we need a dedicated folder on the host to link this too, it can be isolated.",
      "range": {
        "startLine": 116,
        "startChar": 0,
        "endLine": 119,
        "endChar": 35
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "81ea7b8f_18520d2c",
        "filename": "charts/ovn/templates/statefulset-ovsdb-sb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 106,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "This seems unnecessary, we should remove it I think.",
      "range": {
        "startLine": 105,
        "startChar": 0,
        "endLine": 106,
        "endChar": 45
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "734dfadd_8837a1e3",
        "filename": "charts/ovn/templates/statefulset-ovsdb-sb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 115,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Which would make this useless too.",
      "range": {
        "startLine": 112,
        "startChar": 0,
        "endLine": 115,
        "endChar": 35
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1576ee60_7563051b",
        "filename": "charts/ovn/templates/statefulset-ovsdb-sb.yaml",
        "patchSetId": 2
      },
      "lineNbr": 119,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Does it make sense to make this an empty directory instead of a hostPath since this is just a database so it doesn\u0027t really need to \"play\" or touch anything there, we don\u0027t use the sockets either AFAIK since we talk over `tcp` only.",
      "range": {
        "startLine": 116,
        "startChar": 0,
        "endLine": 119,
        "endChar": 35
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a7141144_f8882d16",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "The full commit for this is:\n\n    chown -R ${ovs_user_id} /etc/openvswitch\n    chown -R ${ovs_user_id} ${OVS_RUNDIR}\n    chown -R ${ovs_user_id} ${OVS_LOGDIR}\n    chown -R ${ovs_user_id} ${OVN_ETCDIR}\n    chown -R ${ovs_user_id} ${OVN_RUNDIR}\n    chown -R ${ovs_user_id} ${OVN_LOGDIR}\n    \nTechnically, I\u0027m thinking if we removed the `ovs` mount from the db servers, couldn\u0027t we just set  `OVS_USER_ID` to `42424` ?\n\nhttps://github.com/ovn-kubernetes/ovn-kubernetes/blob/master/dist/images/ovnkube.sh\n\nMaybe I\u0027m missing something here though.",
      "range": {
        "startLine": 20,
        "startChar": 0,
        "endLine": 22,
        "endChar": 36
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "537f671a_dbf73676",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2025-01-17T01:44:17Z",
      "side": 1,
      "message": "I have tried this before, https://github.com/vexxhost/atmosphere/pull/2044, but there are still issue , with this, we may need also run openvswitchd in non-root,\nI also share with customer that we have two way to fix the issue, 1. just correct the directory permission issue with script like this patch. 2. continue work on using the OVS_USER_ID, which may need more changes.",
      "parentUuid": "a7141144_f8882d16",
      "range": {
        "startLine": 20,
        "startChar": 0,
        "endLine": 22,
        "endChar": 36
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4827814f_f0322dfa",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-17T01:57:53Z",
      "side": 1,
      "message": "I see, so the issue is that we run ovs as root but ovn as non-root, is that it?",
      "parentUuid": "537f671a_dbf73676",
      "range": {
        "startLine": 20,
        "startChar": 0,
        "endLine": 22,
        "endChar": 36
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b9ce764d_0dba7cd4",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2025-01-17T02:03:27Z",
      "side": 1,
      "message": "Yes, we need both to be consistent, the customer also set their custom fix using ovs_user_id, but have the bridge socket file issue.",
      "parentUuid": "4827814f_f0322dfa",
      "range": {
        "startLine": 20,
        "startChar": 0,
        "endLine": 22,
        "endChar": 36
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e21fdcfc_523b0dc3",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 22,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-17T02:27:40Z",
      "side": 1,
      "message": "and if I understand the scope of the problem correctly:\n\n- ovsdb-server runs as non-root (42424)\n- ovs-vswitchd runs as root\n- ovn-controller runs as root\n- qemu processes run as non-root (42424)\n\nso technically, I think ovsdb-server being non-root doesn\u0027t matter because it\u0027s just a server, things connect to it, and it matches qemu anyways.\n\nqemu tries to start the dpdk process in the run dir but permission is root there, so its not able to write since its using user 42424\n\nit seems redhat has been running ovs as non-root:\n\nhttps://developers.redhat.com/blog/2018/03/23/non-root-open-vswitch-rhel\n\nso why don\u0027t we:\n\n1. in ovs, add initContainer to set permissions to 42424 for ovs folders\n1. in ovs, set permissions for /dev/hugepages to 42424 (see https://github.com/openvswitch/ovs/blob/caed64d1685409d1f9b53b35621a08ad6588200c/rhel/usr_lib_systemd_system_ovs-vswitchd.service.in#L20)\n2. in ovs, start running it as 42424 with `--user` set to whatever 42424 user is (see user flag https://www.openvswitch.org/support/dist-docs/ovs-vswitchd.8.txt)\n3. at this point, ovs will be running as 42424 (non-root)\n4. all other services are 42424 so everything is still ok, except ovn-controller but its root so it can keep working\n5. switch ovn-controller to running on 42424, will be able to talk to local sock because 42424 and it doesnt really do anything other than talk to ovs (kernel level)\n\nthat will transition everything out of root into 42424 successfully I think",
      "parentUuid": "b9ce764d_0dba7cd4",
      "range": {
        "startLine": 20,
        "startChar": 0,
        "endLine": 22,
        "endChar": 36
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "07ac10f4_892f7315",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 35,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Do you think this is a but with upstream?",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 35,
        "endChar": 86
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4d5fa7eb_c9dfb066",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 35,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2025-01-17T01:44:17Z",
      "side": 1,
      "message": "yeah, I can make it upstream.",
      "parentUuid": "07ac10f4_892f7315",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 35,
        "endChar": 86
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "12ccc899_0be0322d",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 35,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-17T01:57:53Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "4d5fa7eb_c9dfb066",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 35,
        "endChar": 86
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a6e6a44b_30027b02",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 42,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Same here.",
      "range": {
        "startLine": 41,
        "startChar": 0,
        "endLine": 42,
        "endChar": 103
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c0142b13_f6de9771",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 51,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Same here",
      "range": {
        "startLine": 50,
        "startChar": 0,
        "endLine": 51,
        "endChar": 85
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6c339e0b_6c219509",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 60,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Same here",
      "range": {
        "startLine": 59,
        "startChar": 0,
        "endLine": 60,
        "endChar": 76
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c12573af_c95c3373",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 77,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-16T20:22:12Z",
      "side": 1,
      "message": "Are we using this function call somewhere?  In that case, then I think we need ovs run mounted so we can make those calls?",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 77,
        "endChar": 3
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d75a5db0_1836427e",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 77,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2025-01-17T01:44:17Z",
      "side": 1,
      "message": "the ovn-kube-util which we use for readiness check calls this, and the RunOVNAppctlWtihTimeout can fallback to use ovs-appctl if ovn-appctl doesn\u0027t exist.",
      "parentUuid": "c12573af_c95c3373",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 77,
        "endChar": 3
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2dd4c262_a27eedb2",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 77,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-17T01:57:53Z",
      "side": 1,
      "message": "Right, but I guess this function is something that is never called because we don\u0027t use the `ovsDaemonsReadiness` or is there something that actually makes this change?",
      "parentUuid": "d75a5db0_1836427e",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 77,
        "endChar": 3
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3472f339_2c4d4ad0",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 77,
      "author": {
        "id": 1000002
      },
      "writtenOn": "2025-01-17T02:03:27Z",
      "side": 1,
      "message": "This is called by ovn-kube-util, which we use for ovn-controller readiness check. so when i update the ovn run dir to use it\u0027s own dir /run/ovn, the ovs-appctl can\u0027t check the ovn service because ovs-appctl using the ovs /run/openvswitch to find the pid file and ctl file.",
      "parentUuid": "2dd4c262_a27eedb2",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 77,
        "endChar": 3
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e68c6fc0_7f08a360",
        "filename": "images/ovn/patches/ovn-kubernetes/0004-ensure-openvswitch-pid-directory-is-accessable-by-no.patch",
        "patchSetId": 2
      },
      "lineNbr": 77,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2025-01-17T02:27:40Z",
      "side": 1,
      "message": "But isn\u0027t this readiness check really trying to check if ovs is alive or not, hence it needs to use ovs-appctl and the mount for /run/ovs is needed?",
      "parentUuid": "3472f339_2c4d4ad0",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 77,
        "endChar": 3
      },
      "revId": "3475efbd4a149423ca56e7909cd0189f7702f4b9",
      "serverId": "a369f105-6bff-480f-8aaf-eafd1f85bb44"
    }
  ]
}