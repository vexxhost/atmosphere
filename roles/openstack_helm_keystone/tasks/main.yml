# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Deploy Service
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVersion: infra.atmosphere.vexxhost.com/v1alpha1
        kind: RabbitmqCluster
        metadata:
          name: keystone
          namespace: openstack
        spec:
          imageRepository: "{{ atmosphere_image_repository | default(None) }}"

      - apiVersion: v1
        kind: Secret
        metadata:
          name: keystone
          namespace: openstack
        type: Opaque
        stringData:
          memcache: "{{ openstack_helm_endpoints_memcached_secret_key }}"
          rabbitmq: "{{ openstack_helm_endpoints_keystone_rabbitmq_password }}"
          database: "{{ openstack_helm_endpoints_keystone_mariadb_password }}"
          admin: "{{ openstack_helm_endpoints_keystone_admin_password }}"

      - apiVersion: openstack.atmosphere.vexxhost.com/v1alpha1
        kind: Keystone
        metadata:
          name: keystone
          namespace: openstack
        spec:
          replicas: 3
          regionName: "{{ openstack_helm_endpoints_keystone_region_name | default(openstack_helm_endpoints_region_name) }}"
          imageRepository: "{{ atmosphere_image_repository | default(None) }}"
          ingress:
            host: "{{ openstack_helm_endpoints_keystone_api_host }}"
            className: "{{ openstack_helm_ingress_class_name | default('openstack') }}"
            annotations: "{{ openstack_helm_keystone_ingress_annotations }}"
          secretsRef:
            name: keystone
          databaseRef:
            name: percona-xtradb
          rabbitmqRef:
            name: keystone
          overrides: "{{ openstack_helm_keystone_values }}"
