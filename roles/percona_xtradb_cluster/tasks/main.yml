- name: Create Percona XtraDB cluster
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: pxc.percona.com/v1-10-0
      kind: PerconaXtraDBCluster
      metadata:
        name: percona-xtradb
        namespace: openstack
      spec:
        crVersion: "1.10.0"
        secretsName: percona-xtradb
        pxc:
          size: 3
          image: "{{ lookup('vexxhost.atmosphere.image_ref', 'percona_xtradb_cluster', output='ref') }}"
          autoRecovery: true
          configuration: |
            [mysqld]
            max_connections=8192
          sidecars:
            - name: exporter
              image: "{{ lookup('vexxhost.atmosphere.image_ref', 'prometheus_mysqld_exporter', output='ref') }}"
              env:
                - name: MONITOR_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: percona-xtradb
                      key: monitor
                - name: DATA_SOURCE_NAME
                  value: "monitor:$(MONITOR_PASSWORD)@(localhost:3306)/"
              ports:
                - name: metrics
                  containerPort: 9104
              livenessProbe:
                httpGet:
                  port: metrics
                  path: /
          nodeSelector:
            openstack-control-plane: enabled
          volumeSpec:
            persistentVolumeClaim:
              resources:
                requests:
                  storage: 160Gi
        haproxy:
          enabled: true
          size: 3
          image: "{{ lookup('vexxhost.atmosphere.image_ref', 'percona_xtradb_cluster_haproxy', output='ref') }}"
          nodeSelector:
            openstack-control-plane: enabled
    wait_sleep: 1
    wait_timeout: 600
    wait: true
    wait_condition:
      type: ready
      status: true
