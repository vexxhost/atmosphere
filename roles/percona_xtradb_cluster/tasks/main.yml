- name: Create a secret for Percona XtraDB cluster passwords
  run_once: true
  block:
    - name: Check if the Percona XtraDB cluster secret exists
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: percona-xtradb
        namespace: openstack
      register: _pxc_secret
      ignore_errors: true

    - name: Create a secret
      when: ( _pxc_secret.resources | length==0 )
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          stringData:
            clustercheck: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
            monitor: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
            operator: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
            proxyadmin: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
            replication: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
            root: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
            xtrabackup: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=32') }}"
          kind: Secret
          metadata:
            name: percona-xtradb
            namespace: openstack
          type: Opaque

- name: Check if the Percona XtraDB cluster exists
  run_once:
  block:
    - name: Check if the Percona XtraDB cluster exists
      kubernetes.core.k8s_info:
        api_version: pxc.percona.com/v1
        kind: PerconaXtraDBCluster
        name: percona-xtradb
        namespace: openstack
      register: _pxc_cluster
      ignore_errors: true

    - name: Get current status of the cluster
      set_fact:
        _pxc_version: "{{ _pxc_cluster.resources[0].status.pxc.version }}"
        _pxc_status: "{{ _pxc_cluster.resources[0].status.state }}"
      when: ( _pxc_cluster.resources | length==1 )

- name: Do smart upgrade
  run_once: true
  when:
    - _pxc_version is defined
    - _pxc_status is defined
    - _pxc_version.startswith('5.7')
  block:
    - name: Assert that the cluster is healthy before upgrade
      run_once: true
      ansible.builtin.assert:
        that:
          - _pxc_status == 'ready'
        fail_msg: >-
          The Percona XtraDB Cluster is not healthy. Please fix the cluster manually first before upgrade.

    - name: Do minor upgrade
      kubernetes.core.k8s:
        definition:
          apiVersion: pxc.percona.com/v1
          kind: PerconaXtraDBCluster
          metadata:
            name: percona-xtradb
            namespace: openstack
          spec:
            crVersion: "1.13.0"
            updateStrategy: SmartUpdate
            upgradeOptions:
              apply: 5.7-latest
              versionServiceEndpoint: http://percona-version-service:11000
              schedule: "* * * * *"
      # Note(oleks): Wait until the upgrade task is queued in the reconcile queue.
      #              Ignore errors in case the cluster is already minor upgraded.
      ignore_errors: true
      register: _pxc_cluster
      retries: 10
      delay: 1
      until:
        - _pxc_cluster.result.status.state == 'initializing'

    - name: Wait until minor upgrade is done
      kubernetes.core.k8s_info:
        api_version: pxc.percona.com/v1
        kind: PerconaXtraDBCluster
        name: percona-xtradb
        namespace: openstack
      register: _pxc_cluster
      retries: 60
      delay: 5
      until:
        - _pxc_cluster.resources[0].status.state == 'ready'

    - name: Do major upgrade
      kubernetes.core.k8s:
        definition:
          apiVersion: pxc.percona.com/v1
          kind: PerconaXtraDBCluster
          metadata:
            name: percona-xtradb
            namespace: openstack
          spec:
            crVersion: "1.13.0"
            updateStrategy: SmartUpdate
            upgradeOptions:
              apply: 8.0.32-24.2
              versionServiceEndpoint: http://percona-version-service:11000
              schedule: "* * * * *"
      # Note(oleks): Wait until the upgrade task is queued in the reconcile queue
      register: _pxc_cluster
      retries: 60
      delay: 1
      until:
        - _pxc_cluster.result.status.state == 'initializing'

    - name: Wait until upgrade is done
      kubernetes.core.k8s_info:
        api_version: pxc.percona.com/v1
        kind: PerconaXtraDBCluster
        name: percona-xtradb
        namespace: openstack
      register: _pxc_cluster
      retries: 60
      delay: 5
      until:
        - _pxc_cluster.resources[0].status.state == 'ready'
        - _pxc_cluster.resources[0].status.pxc.version.startswith('8.0')

- name: Apply Percona XtraDB cluster
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: pxc.percona.com/v1
      kind: PerconaXtraDBCluster
      metadata:
        name: percona-xtradb
        namespace: openstack
      spec: "{{ _percona_xtradb_cluster_spec | combine(percona_xtradb_cluster_spec, recursive=True) }}"
    wait_sleep: 1
    wait_timeout: 600
    wait: true
    wait_condition:
      type: ready
      status: true
