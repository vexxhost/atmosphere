# Copyright (c) 2024 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Create OpenStack user
  openstack.cloud.identity_user:
    cloud: atmosphere
    name: "{{ openstack_helm_endpoints.identity.auth.rgw.username }}"
    password: "{{ openstack_helm_endpoints.identity.auth.rgw.password }}"
    domain: service

- name: Grant access to "service" project
  openstack.cloud.role_assignment:
    cloud: atmosphere
    domain: service
    user: "{{ openstack_helm_endpoints.identity.auth.rgw.username }}"
    project: service
    role: admin

- name: Create OpenStack service
  openstack.cloud.catalog_service:
    cloud: atmosphere
    name: swift
    service_type: object-store
    description: OpenStack Object Storage

- name: Create OpenStack endpoints
  openstack.cloud.endpoint:
    cloud: atmosphere
    service: swift
    endpoint_interface: "{{ item.interface }}"
    url: "{{ item.url }}"
    region: "{{ openstack_helm_endpoints.identity.auth.rgw.region_name }}"
  loop:
    - interface: public
      url: "https://{{ openstack_helm_endpoints.rook_ceph_cluster.host_fqdn_override.public.host }}/swift/v1/%(tenant_id)s"
    - interface: internal
      url: "http://rook-ceph-rgw-ceph.{{ rook_ceph_cluster_helm_release_namespace }}.svc.cluster.local/swift/v1/%(tenant_id)s"

- name: Create Rados Gateway Ingress
  ansible.builtin.include_role:
    name: openstack_helm_ingress
  vars:
    openstack_helm_ingress_endpoint: rook_ceph_cluster
    openstack_helm_ingress_namespace: "{{ rook_ceph_cluster_helm_release_namespace }}"
    openstack_helm_ingress_service_name: rook-ceph-rgw-ceph
    openstack_helm_ingress_service_port: "{{ '8088' if atmosphere_rook_ceph_enabled is defined and atmosphere_rook_ceph_enabled | bool else '80' }}"
    openstack_helm_ingress_annotations: "{{ _rook_ceph_cluster_radosgw_annotations | combine(rook_ceph_cluster_radosgw_annotations, recursive=True) }}"

- name: Create Ceph Dashboard Ingress
  ansible.builtin.include_role:
    name: ingress
  vars:
    ingress_name: rook-ceph-dashboard
    ingress_namespace: "{{ rook_ceph_cluster_helm_release_namespace }}"
    ingress_class_name: "{{ atmosphere_ingress_class_name }}"
    ingress_host: "{{ rook_ceph_dashboard_host }}"
    ingress_service_name: rook-ceph-mgr-dashboard
    ingress_service_port: 9088
    ingress_annotations:
      cert-manager.io/cluster-issuer: atmosphere
  when: atmosphere_rook_ceph_enabled is defined and atmosphere_rook_ceph_enabled | bool
