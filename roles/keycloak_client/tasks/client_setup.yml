# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- block:
  - name: Keycloak server health check
    ansible.builtin.uri:
      url: "https://{{ keycloak_host }}/health/ready"
      return_content: true
      validate_certs: false
    register: this
    retries: 60
    delay: 5
    until: this is not failed and "'UP' in this.content"

  - set_fact:
      keycloak_client_redirect_uris:
        - "https://{{ openstack_helm_endpoints_keystone_api_host }}/v3/OS-FEDERATION/identity_providers/{{ _ks_domain.key }}/protocols/openid/auth"
        - "https://{{ openstack_helm_endpoints_horizon_api_host }}/auth/logout/"
  - name: Create clients
    community.general.keycloak_client:
      auth_client_id: admin-cli
      auth_keycloak_url: "https://{{  keycloak_host  }}"
      auth_realm: master
      auth_username: "{{ keycloak_client_admin_username }}"
      auth_password: "{{ keycloak_client_admin_password }}"
      state: present
      realm: "{{ _ks_domain.key }}"
      client_id: keystone
      name: keystone
      root_url: "{{ _ks_domain.value.keycloak.server_url | default(omit) }}"
      admin_url: "{{ keycloak_client_admin_url | default(omit) }}"
      base_url: "{{ keycloak_client_base_url | default(omit) }}"
      enabled: true
      client_authenticator_type: client-secret
      public_client: false
      secret: "{{ keycloak_client_secret | default(omit) }}"
      redirect_uris: "{{ keycloak_client_redirect_uris | default(omit) }}"
      web_origins: "{{ keycloak_client_web_origins | default(omit) }}"
      standard_flow_enabled: "{{ keycloak_client_standard_flow_enabled | default(omit) }}"
      direct_access_grants_enabled: "{{ keycloak_client_direct_access_grants_enabled | default(omit) }}"
      implicit_flow_enabled: "{{ keycloak_client_implicit_flow_enabled | default(omit) }}"
      protocol: "{{ keycloak_client_protocol | default('openid-connect') }}"
    retries: 60
    delay: 5
    register: keycloak_client_result
    until: keycloak_client_result is not failed

  - name: Create client role
    community.general.keycloak_role:
      auth_client_id: admin-cli
      auth_keycloak_url: "https://{{ keycloak_host }}"
      auth_realm: master
      auth_username: "{{ keycloak_client_admin_username }}"
      auth_password: "{{ keycloak_client_admin_password }}"
      state: present
      realm: "{{ _ks_domain.value.keycloak.user_realm_name }}"
      client_id: "{{ _ks_domain.key }}"
      name: "{{ item }}"
    loop: "{{ keycloak_client_roles }}"
  when: _ks_domain.value.keycloak is defined
