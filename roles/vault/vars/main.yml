# Copyright (c) 2025 VEXXHOST, Inc.
# SPDX-License-Identifier: Apache-2.0

_vault_spec:
  size: 3
  image: "{{ atmosphere_images['vault'] }}"
  nodeSelector:
    openstack-control-plane: enabled
  serviceAccount: vault
  serviceType: ClusterIP
  # NOTE(fitbeard): We do external ingress configuration
  ingress: null
  volumeClaimTemplates:
    - metadata:
        name: vault-raft
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
  volumes:
    - name: vault-raft
      persistentVolumeClaim:
        claimName: vault-raft
  volumeMounts:
    - name: vault-raft
      mountPath: /vault/data
  caNamespaces:
    - "*"
  unsealConfig:
    options:
      preFlightChecks: true
      storeRootToken: true
      secretShares: 5
      secretThreshold: 3
    kubernetes:
      secretNamespace: "{{ vault_namespace }}"
  config:
    storage:
      raft:
        path: /vault/data
    listener:
      tcp:
        address: 0.0.0.0:8200
        tls_cert_file: /vault/tls/server.crt
        tls_key_file: /vault/tls/server.key
    api_addr: "https://vault.{{ vault_namespace }}:8200"
    cluster_addr: "https://${.Env.POD_NAME}:8201"
    disable_mlock: true
    ui: true
    plugin_directory: /vault/plugins
    service_registration:
      kubernetes: {}
    telemetry:
      unauthenticated_metrics_access: true
  statsdDisabled: true
  serviceRegistrationEnabled: true
  externalConfig: {}
  secretInitsConfig:
    - name: VAULT_LOG_LEVEL
      value: "{{ vault_log_level }}"

# NOTE(fitbeard): Merging with overrides can lead to unexpected results.
# The best way to extend this configuration is to fully override it
# with your own configuration.
_vault_config:
  vault-config.yml: |
    purgeUnmanagedConfig:
      enabled: false
    auth:
      - type: approle
        path: approle
        options:
          listing_visibility: hidden
        roles:
          - name: ansible
            description: Ansible role for Vault
            secret_id_ttl: 2m
            secret_id_num_uses: 1
            token_ttl: 5m
            token_max_ttl: 10m
            token_type: default
            token_policies: ["write_kv_all"]
      - type: kubernetes
        path: {{ atmosphere_vault_kubernetes_auth_path }}
        description: Kubernetes authentication for local cluster
        config:
          kubernetes_host: https://kubernetes.default.svc
        roles:
          - name: ansible
            bound_service_account_names: ["ansible"]
            bound_service_account_namespaces: ["{{ vault_namespace | quote }}"]
            # https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/
            # https://outshift.cisco.com/blog/kubernetes-oidc
            # https://support.hashicorp.com/hc/en-us/articles/34458984727443-Audience-parameter-usage-with-kube-auth-in-vault-with-caveats
            audience: https://kubernetes.default.svc.cluster.local
            policies: ["ansible"]
            ttl: 1m
          - name: external-secrets-cluster-secret-store
            bound_service_account_names: ["external-secrets"]
            bound_service_account_namespaces: ["external-secrets"]
            audience: https://kubernetes.default.svc.cluster.local
            policies: ["read_kv_all"]
            ttl: 1h
          - name: vault
            bound_service_account_names: ["*"]
            bound_service_account_namespaces: ["{{ vault_namespace | quote }}", "openstack"]
            audience: https://kubernetes.default.svc.cluster.local
            policies: ["read_kv_all"]
            ttl: 1h
    policies:
      - name: ansible
        rules: |
          path "auth/approle/role/ansible/role-id" {
            capabilities = [ "read" ]
          }
          path "auth/approle/role/ansible/secret-id" {
             capabilities = [ "update" ]
          }
      - name: read_kv_all
        rules: |
          path "{{ atmosphere_vault_mount_point }}/data/*" {
            capabilities = ["read"]
          }
      - name: write_kv_all
        rules: |
          path "{{ atmosphere_vault_mount_point }}/metadata" {
            capabilities = ["list"]
          }
          path "{{ atmosphere_vault_mount_point }}/metadata/*" {
            capabilities = ["read", "list"]
          }
          path "{{ atmosphere_vault_mount_point }}/data/*" {
            capabilities = ["create", "update", "patch", "read", "delete"]
          }
    secrets:
      - type: kv-v2
        path: {{ atmosphere_vault_mount_point }}
        description: Atmosphere static secrets

_vault_ingress_annotations:
  cert-manager.io/cluster-issuer: "{{ vault_ingress_cluster_issuer }}"
  nginx.ingress.kubernetes.io/backend-protocol: https

# NOTE(fitbeard): Merging with overrides can lead to unexpected results.
# The best way to extend this configuration is to fully override it
# with your own configuration.
_vault_keycloak_config:
  vault-config.yml: |
    auth:
      - type: oidc
        path: oidc
        description: Keycloak OIDC Authentication backend
        options:
          listing_visibility: unauth
          default_lease_ttl: 1h
          max_lease_ttl: 1h
          token_type: default-service
        config:
          oidc_discovery_url: "https://{{ keycloak_host }}/realms/{{ vault_keycloak_realm }}"
          bound_issuer: "{{ keycloak_host }}"
          oidc_client_id: "{{ vault_keycloak_client_id }}"
          oidc_client_secret: "{{ vault_keycloak_client_secret }}"
          default_role: "default"
        roles:
          - name: default
            token_type: default
            token_no_default_policy: true
            token_policies: []
            token_max_ttl: 1h
            token_ttl: 1h
            user_claim: "sub"
            groups_claim: "groups"
            oidc_scopes: ["openid"]
            bound_audiences: ["{{ vault_keycloak_client_id | quote }}"]
            allowed_redirect_uris:
              - "https://{{ vault_host }}/ui/vault/auth/oidc/oidc/callback"
              - "http://localhost:8250/oidc/callback"
            bound_claims:
              groups: "/vault_admins"
    groups:
      - name: vault_admins
        policies:
          - default
          - write_kv_all
        type: external
    group-aliases:
      - name: "/vault_admins"
        mountpath: oidc
        group: vault_admins
