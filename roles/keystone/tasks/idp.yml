# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- block:
    - name: Get the ID of the Atmosphere domain
      openstack.cloud.identity_domain_info:
        cloud: atmosphere
        name: "{{ _ks_domain.value.keycloak.realm_name }}"
      register: _keystone_atmosphere_domain_info
      until: _keystone_atmosphere_domain_info is not failed
      retries: 60
      delay: 5
      tags:
        - keystone-identity-provider

    - name: Create identity provider
      openstack.cloud.federation_idp:
        cloud: atmosphere
        name: "{{ _ks_domain.value.keycloak.realm_name }}-idp"
        description: Created by Atmosphere
        domain_id: "{{ _keystone_atmosphere_domain_info.openstack_domains[0].id }}"
        remote_ids:
          - "https://{{ keycloak_host }}/realms/{{ _ks_domain.value.keycloak.realm_name }}"
      tags:
        - keystone-identity-provider

    - name: Create federation mapping
      openstack.cloud.federation_mapping:
        cloud: atmosphere
        name: "{{ _ks_domain.value.keycloak.realm_name }}-openid"
        rules:
          - local:
              - user:
                  type: local
                  id: "{0}"
                  domain:
                    name: "{{ _ks_domain.value.keycloak.realm_name }}"
            remote:
              - type: OIDC-sub
      tags:
        - keystone-federation-mapping

    - name: Create a federation protocol
      openstack.cloud.keystone_federation_protocol:
        cloud: atmosphere
        name: openid
        idp_id: "{{ _ks_domain.value.keycloak.realm_name }}-idp"
        mapping_id: "{{ _ks_domain.value.keycloak.realm_name }}-openid"
      tags:
        - keystone-federation-protocol
  when: _ks_domain.value.keycloak is defined
