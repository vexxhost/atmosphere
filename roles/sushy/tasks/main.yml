# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: prepare ovmf images
  run_once: true
  ansible.builtin.shell: |
    # make sure ovmf files exists in image path
    apt install ovmf -y
    cp -r /usr/share/OVMF /var/lib/libvirt/images/

- name: Deploy Sushy (Redfish emulator) service
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          namespace: openstack
          name: sushy-config
        data:
          emulator.config: |
            SUSHY_EMULATOR_BOOT_LOADER_MAP = {
                'UEFI': {
                    'x86_64': '/var/lib/libvirt/images/OVMF_CODE_4M.fd'
                },
                'Legacy': {
                    'x86_64': None
                }
            }
            SUSHY_EMULATOR_FEATURE_SET = "full"

- name: Deploy Sushy (Redfish emulator) service
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVersion: apps/v1
        kind: DaemonSet
        metadata:
          name: sushy
          namespace: openstack
          labels:
            application: sushy
        spec:
          selector:
            matchLabels:
              application: sushy
          template:
            metadata:
              labels:
                application: sushy
            spec:
              nodeSelector:
                openstack-control-plane: enabled
              hostNetwork: true
              hostPID: true
              hostIPC: true
              dnsPolicy: ClusterFirstWithHostNet
              initContainers:
                - name: build-config
                  image: "{{ atmosphere_images['bootstrap'] | vexxhost.kubernetes.docker_image('ref') }}"
                  command: ["bash", "-ec"]
                  args:
                    - |
                      cat <<EOF > /etc/openstack/clouds.yaml
                      ---
                      clouds:
                        default:
                          auth:
                            auth_url: "$(OS_AUTH_URL)"
                            project_domain_name: "$(OS_PROJECT_DOMAIN_NAME)"
                            project_name: "$(OS_PROJECT_NAME)"
                            user_domain_name: "$(OS_USER_DOMAIN_NAME)"
                            username: "$(OS_USERNAME)"
                            password: "$(OS_PASSWORD)"
                          region_name: "$(OS_REGION_NAME)"
                          interface: "$(OS_INTERFACE)"
                          identity_api_version: 3
                          identity_interface: "$(OS_INTERFACE)"
                      EOF
                  envFrom:
                    - secretRef:
                        name: keystone-keystone-admin
                  volumeMounts:
                    - name: openstack-config
                      mountPath: /etc/openstack
              containers:
                - name: sushy
                  image: "{{ atmosphere_images['sushy'] | vexxhost.kubernetes.docker_image('ref') }}"
                  securityContext:
                    privileged: true
                    readOnlyRootFilesystem: false
                  readinessProbe:
                    failureThreshold: 3
                    httpGet:
                      path: /redfish/v1/
                      port: 9132
                      scheme: HTTP
                  livenessProbe:
                    failureThreshold: 3
                    httpGet:
                      path: /redfish/v1/
                      port: 9132
                      scheme: HTTP
                    periodSeconds: 10
                    successThreshold: 1
                    timeoutSeconds: 1
                  command:
                    - /bin/bash
                    - -c
                    - exec gunicorn sushy_tools.emulator.main:app --bind 0.0.0.0:9132 --env FLASK_DEBUG=1 --env SUSHY_EMULATOR_CONFIG=/etc/ironic/redfish/emulator.conf --env SUSHY_EMULATOR_LIBVIRT_URI=qemu+unix:///system?socket=/run/libvirt/libvirt-sock --workers 1 --threads 1 --timeout 90
                  volumeMounts:
                    - name: openstack-config
                      mountPath: /etc/openstack
                    - name: config-sushy
                      mountPath: /etc/ironic/redfish/emulator.conf
                      subPath: emulator.config
                    - name: pod-tmp
                      mountPath: /tmp
                    - name: libvirt-etc
                      mountPath: /etc/libvirt/qemu.conf
                      subPath: qemu.conf
                      readOnly: true
                    - name: etc-libvirt-qemu
                      mountPath: /etc/libvirt/qemu
                    - mountPath: /lib/modules
                      name: libmodules
                      readOnly: true
                    - name: var-lib-libvirt
                      mountPath: /var/lib/libvirt
                      mountPropagation: Bidirectional
                    - name: var-lib-nova
                      mountPath: /var/lib/nova
                      mountPropagation: Bidirectional
                    - name: run
                      mountPath: /run
                    - name: dev
                      mountPath: /dev
                    - name: cgroup
                      mountPath: /sys/fs/cgroup
                    - name: logs
                      mountPath: /var/log/libvirt
                    - name: machine-id
                      mountPath: /etc/machine-id
                      readOnly: true
              volumes:
                - name: openstack-config
                  emptyDir: {}
                - name: config-sushy
                  configMap:
                    name: sushy-config
                - name: pod-tmp
                  emptyDir: {}
                - name: libvirt-etc
                  secret:
                    secretName: libvirt-libvirt-default-etc
                    defaultMode: 0444
                - name: libmodules
                  hostPath:
                    path: /lib/modules
                - name: var-lib-libvirt
                  hostPath:
                    path: /var/lib/libvirt
                - name: var-lib-nova
                  hostPath:
                    path: /var/lib/nova
                - name: run
                  hostPath:
                    path: /run
                - name: run-libvirt
                  hostPath:
                    path: /run/libvirt
                - name: dev
                  hostPath:
                    path: /dev
                - name: logs
                  hostPath:
                    path: /var/log/libvirt
                - name: cgroup
                  hostPath:
                    path: /sys/fs/cgroup
                - name: machine-id
                  hostPath:
                    path: /etc/machine-id
                - name: etc-libvirt-qemu
                  hostPath:
                    path: /etc/libvirt/qemu
                - name: etc-modprobe-d
                  hostPath:
                    path: /etc/modprobe.d
                - name: host-rootfs
                  hostPath:
                    path: /
                    type: Directory

- name: Get OVS pods info
  kubernetes.core.k8s_info:
    api_version: apps/v1
    namespace: openstack
    kind: Pod
    label_selectors:
      - application=openvswitch
      - component=server
  register: ovs_pod

- name: Create "ironic-pxe" bridge
  kubernetes.core.k8s_exec:
    namespace: openstack
    pod: "{{ ovs_pod.resources[0].metadata.name }}"
    command: ovs-vsctl --may-exist add-br ironic-pxe
  when: ovs_pod.resources | length > 0

- name: Create connection between "ironic-pxe" and "br-ex"
  kubernetes.core.k8s_exec:
    namespace: openstack
    pod: "{{ ovs_pod.resources[0].metadata.name }}"
    command: >-
      ovs-vsctl
      --may-exist add-port br-ex patch-ex-ironic-pxe
      -- set interface patch-ex-ironic-pxe type=patch options:peer=patch-ironic-pxe-ex
      -- set port patch-ex-ironic-pxe tag=4090
      -- --may-exist add-port ironic-pxe patch-ironic-pxe-ex
      -- set interface patch-ironic-pxe-ex type=patch options:peer=patch-ex-ironic-pxe
  when: ovs_pod.resources | length > 0

- name: Create node ports on ironic-pxe
  kubernetes.core.k8s_exec:
    namespace: default
    pod: "{{ ovs_pod.resources[0].metadata.name }}"
    command: >-
      ovs-vsctl
      --no-wait add-port ironic-pxe ovs-node-0i1
      -- --no-wait add-port ironic-pxe ovs-node-0i2
      -- --no-wait add-port ironic-pxe ovs-node-1i1
      -- --no-wait add-port ironic-pxe ovs-node-1i2
  when: ovs_pod.resources | length > 0

- name: Add IP address to "ironic-pxe"
  changed_when: false
  ansible.builtin.shell:
    cmd: ip addr add 172.24.6.254/24 dev ironic-pxe || true

- name: Set "ironic-pxe" interface to "up"
  changed_when: false
  ansible.builtin.shell:
    cmd: ip link set ironic-pxe up || true

- name: Get OVS pods info
  kubernetes.core.k8s_info:
    api_version: apps/v1
    namespace: openstack
    kind: Pod
    label_selectors:
      - application=libvirt
      - component=libvirt
  register: libvirt_pod

- name: Expose "ironic-pxe" bridge for virtual baremetal nodes
  kubernetes.core.k8s_exec:
    namespace: openstack
    pod: "{{ libvirt_pod.resources[0].metadata.name }}"
    container: libvirt
    command:
      - "/bin/bash"
      - "-c"
      - |
        cat > ironic-pxe.xml << END
        <network>
          <name>ironic-pxe</name>
          <forward mode='bridge'/>
          <bridge name='ironic-pxe'/>
          <virtualport type='openvswitch'/>
        </network>
        END
        virsh net-define ironic-pxe.xml
        virsh net-autostart  ironic-pxe
        virsh net-start ironic-pxe
  when: libvirt_pod.resources | length > 0

- name: Create storage for virtual baremetal nodes
  kubernetes.core.k8s_exec:
    namespace: openstack
    pod: "{{ libvirt_pod.resources[0].metadata.name }}"
    container: libvirt
    command:
      - "/bin/bash"
      - "-c"
      - |
        virsh pool-define-as --name default dir --target /var/lib/libvirt/images
        virsh pool-autostart default
        virsh pool-start default
        virsh vol-create-as default node-0.raw 11G --allocation 0 --format raw
        virsh vol-create-as default node-1.raw 11G --allocation 0 --format raw
        virsh vol-path --pool default node-0.raw
        virsh vol-path --pool default node-1.raw
  when: libvirt_pod.resources | length > 0

- name: Create node-0 virtual baremetal node
  kubernetes.core.k8s_exec:
    namespace: openstack
    pod: "{{ libvirt_pod.resources[0].metadata.name }}"
    container: libvirt
    command:
      - "/bin/bash"
      - "-c"
      - |
        cat > node-0.xml << END
        <domain type='qemu'>
          <name>node-0</name>
          <uuid>fb3ed2f2-60f0-4e6b-b53e-6d8b40d6121d</uuid>
          <memory unit='KiB'>2560000</memory>
          <currentMemory unit='KiB'>2560000</currentMemory>
          <vcpu placement='static'>1</vcpu>
          <os>
            <type arch='x86_64' machine='pc-q35-6.2'>hvm</type>
            <loader readonly='yes' type='pflash'>/var/lib/libvirt/images/OVMF_CODE_4M.fd</loader>
            <nvram template='/var/lib/libvirt/images/OVMF_VARS_4M.fd'>/var/lib/libvirt/images/OVMF_VARS_4M.fd-node-0</nvram>
            <bootmenu enable='no'/>
            <bios useserial='yes'/>
          </os>
          <features>
            <acpi/>
            <apic/>
            <pae/>
          </features>
          <cpu mode='host-model' check='partial'/>
          <clock offset='utc'/>
          <on_poweroff>destroy</on_poweroff>
          <on_reboot>destroy</on_reboot>
          <on_crash>restart</on_crash>
          <devices>
            <emulator>/usr/bin/qemu-system-x86_64</emulator>
            <disk type='file' device='disk'>
              <driver name='qemu' type='raw' cache='unsafe'/>
              <source file='/var/lib/libvirt/images/node-0.raw'/>
              <blockio logical_block_size='512' physical_block_size='512'/>
              <target dev='vda' bus='virtio'/>
              <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>
            </disk>
            <controller type='usb' index='0' model='qemu-xhci'>
              <address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/>
            </controller>
            <controller type='sata' index='0'>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/>
            </controller>
            <controller type='pci' index='0' model='pcie-root'/>
            <controller type='pci' index='1' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='1' port='0x8'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0' multifunction='on'/>
            </controller>
            <controller type='pci' index='2' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='2' port='0x9'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>
            </controller>
            <controller type='pci' index='3' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='3' port='0xa'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>
            </controller>
            <controller type='pci' index='4' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='4' port='0xb'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x3'/>
            </controller>
            <controller type='pci' index='5' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='5' port='0xc'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x4'/>
            </controller>
            <controller type='pci' index='6' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='6' port='0xd'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x5'/>
            </controller>
            <interface type='ethernet'>
              <mac address='52:54:00:b9:0b:41'/>
              <target dev='ovs-node-0i1'/>
              <model type='virtio'/>
              <boot order='1'/>
              <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>
            </interface>
            <interface type='ethernet'>
              <mac address='52:54:00:98:d6:b8'/>
              <target dev='ovs-node-0i2'/>
              <model type='virtio'/>
              <boot order='2'/>
              <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>
            </interface>
            <serial type='file'>
              <source path='/tmp/node-0_console.log'/>
              <target type='isa-serial' port='0'>
                <model name='isa-serial'/>
              </target>
            </serial>
            <serial type='pty'>
              <target type='isa-serial' port='1'>
                <model name='isa-serial'/>
              </target>
            </serial>
            <console type='file'>
              <source path='/tmp/node-0_console.log'/>
              <target type='serial' port='0'/>
            </console>
            <input type='mouse' bus='ps2'/>
            <input type='keyboard' bus='ps2'/>
            <audio id='1' type='none'/>
            <memballoon model='virtio'>
              <address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/>
            </memballoon>
          </devices>
        </domain>
        END
        virsh define node-0.xml
        virsh start node-0
  when: libvirt_pod.resources | length > 0

- name: Create node-1 virtual baremetal node
  kubernetes.core.k8s_exec:
    namespace: openstack
    pod: "{{ libvirt_pod.resources[0].metadata.name }}"
    container: libvirt
    command:
      - "/bin/bash"
      - "-c"
      - |
        cat > node-1.xml << END
        <domain type='qemu'>
          <name>node-1</name>
          <uuid>e316d87c-ebc7-4c10-a9bb-316cd8dcfa55</uuid>
          <memory unit='KiB'>2560000</memory>
          <currentMemory unit='KiB'>2560000</currentMemory>
          <vcpu placement='static'>1</vcpu>
          <os>
            <type arch='x86_64' machine='pc-q35-6.2'>hvm</type>
            <loader readonly='yes' type='pflash'>/var/lib/libvirt/images/OVMF_CODE_4M.fd</loader>
            <nvram template='/var/lib/libvirt/images/OVMF_VARS_4M.fd'>/var/lib/libvirt/images/OVMF_VARS_4M.fd-node-1</nvram>
            <bootmenu enable='no'/>
            <bios useserial='yes'/>
          </os>
          <features>
            <acpi/>
            <apic/>
            <pae/>
          </features>
          <cpu mode='host-model' check='partial'/>
          <clock offset='utc'/>
          <on_poweroff>destroy</on_poweroff>
          <on_reboot>destroy</on_reboot>
          <on_crash>restart</on_crash>
          <devices>
            <emulator>/usr/bin/qemu-system-x86_64</emulator>
            <disk type='file' device='disk'>
              <driver name='qemu' type='raw' cache='unsafe'/>
              <source file='/var/lib/libvirt/images/node-1.raw'/>
              <blockio logical_block_size='512' physical_block_size='512'/>
              <target dev='vda' bus='virtio'/>
              <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>
            </disk>
            <controller type='usb' index='0' model='qemu-xhci'>
              <address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/>
            </controller>
            <controller type='sata' index='0'>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/>
            </controller>
            <controller type='pci' index='0' model='pcie-root'/>
            <controller type='pci' index='1' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='1' port='0x8'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0' multifunction='on'/>
            </controller>
            <controller type='pci' index='2' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='2' port='0x9'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>
            </controller>
            <controller type='pci' index='3' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='3' port='0xa'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x2'/>
            </controller>
            <controller type='pci' index='4' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='4' port='0xb'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x3'/>
            </controller>
            <controller type='pci' index='5' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='5' port='0xc'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x4'/>
            </controller>
            <controller type='pci' index='6' model='pcie-root-port'>
              <model name='pcie-root-port'/>
              <target chassis='6' port='0xd'/>
              <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x5'/>
            </controller>
            <interface type='ethernet'>
              <mac address='52:54:00:b7:de:53'/>
              <target dev='ovs-node-1i1'/>
              <model type='virtio'/>
              <boot order='1'/>
              <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>
            </interface>
            <interface type='ethernet'>
              <mac address='52:54:00:29:5d:5a'/>
              <target dev='ovs-node-1i2'/>
              <model type='virtio'/>
              <boot order='2'/>
              <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>
            </interface>
            <serial type='file'>
              <source path='/tmp/node-1_console.log'/>
              <target type='isa-serial' port='0'>
                <model name='isa-serial'/>
              </target>
            </serial>
            <serial type='pty'>
              <target type='isa-serial' port='1'>
                <model name='isa-serial'/>
              </target>
            </serial>
            <console type='file'>
              <source path='/tmp/node-1_console.log'/>
              <target type='serial' port='0'/>
            </console>
            <input type='mouse' bus='ps2'/>
            <input type='keyboard' bus='ps2'/>
            <audio id='1' type='none'/>
            <memballoon model='virtio'>
              <address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/>
            </memballoon>
          </devices>
        </domain>
        END
        virsh define node-1.xml
        virsh start node-1
  when: libvirt_pod.resources | length > 0

- name: Prepare Ironic virtual nodes
  run_once: true
  ansible.builtin.shell: |
    set -o posix
    source /etc/profile.d/atmosphere.sh
    chassis_id=$(openstack --os-cloud system baremetal chassis create --description 'ironic test chassis' -f value -c uuid)
    openstack --os-cloud system baremetal node create  --uuid 43ef224b-6e77-495d-8702-0745fdcad579 --chassis $chassis_id --driver redfish --name node-0 --resource-class baremetal --property cpu_arch=x86_64 --property capabilities=boot_mode:uefi --driver-info redfish_address=http://0.0.0.0:9132  --driver-info redfish_username=admin --driver-info redfish_password=password --driver-info redfish_system_id=/redfish/v1/Systems/node-0
    openstack --os-cloud system baremetal node add trait 43ef224b-6e77-495d-8702-0745fdcad579 CUSTOM_GOLD
    openstack --os-cloud system baremetal node manage  43ef224b-6e77-495d-8702-0745fdcad579 --wait
    openstack --os-cloud system baremetal port create --node 43ef224b-6e77-495d-8702-0745fdcad579 52:54:00:b9:0b:41
    openstack --os-cloud system baremetal port create --node 43ef224b-6e77-495d-8702-0745fdcad579 52:54:00:98:d6:b8
    openstack --os-cloud system baremetal node provide  43ef224b-6e77-495d-8702-0745fdcad579
    openstack --os-cloud system baremetal node create  --uuid 6abb7cdf-66ab-441f-8f94-0dfa955a7716 --chassis $chassis_id --driver redfish --name node-1 --resource-class baremetal --property cpu_arch=x86_64 --property capabilities=boot_mode:uefi --driver-info redfish_address=http://0.0.0.0:9132  --driver-info redfish_username=admin --driver-info redfish_password=password --driver-info redfish_system_id=/redfish/v1/Systems/node-1
    openstack --os-cloud system baremetal node add trait 6abb7cdf-66ab-441f-8f94-0dfa955a7716 CUSTOM_GOLD
    openstack --os-cloud system baremetal node manage  6abb7cdf-66ab-441f-8f94-0dfa955a7716 --wait
    openstack --os-cloud system baremetal port create --node 6abb7cdf-66ab-441f-8f94-0dfa955a7716 52:54:00:b7:de:53
    openstack --os-cloud system baremetal port create --node 6abb7cdf-66ab-441f-8f94-0dfa955a7716 52:54:00:29:5d:5a
    openstack --os-cloud system baremetal node provide  6abb7cdf-66ab-441f-8f94-0dfa955a7716
  args:
    executable: /bin/bash
  environment:
    OS_CLOUD: system
  register: _ironic_prepare_node
  changed_when: _ironic_prepare_node.rc == 0
  failed_when: _ironic_prepare_node.rc != 0

- name: Prepare Ironic baremetal flavor
  run_once: true
  ansible.builtin.shell: |
    set -o posix
    source /etc/profile.d/atmosphere.sh
    openstack --os-cloud atmosphere flavor create --ephemeral 0 --ram 2500 --disk 10 --vcpus 1 baremetal
    openstack --os-cloud atmosphere flavor set baremetal --property resources:CUSTOM_BAREMETAL=1
    openstack --os-cloud atmosphere flavor set baremetal --property resources:DISK_GB=0
    openstack --os-cloud atmosphere flavor set baremetal --property resources:MEMORY_MB=0
    openstack --os-cloud atmosphere flavor set baremetal --property resources:VCPU=0
    openstack --os-cloud atmosphere flavor set baremetal --property cpu_arch=x86_64
    openstack --os-cloud atmosphere flavor set baremetal --property capabilities:boot_mode=uefi
    openstack --os-cloud atmosphere flavor set baremetal --property trait:CUSTOM_GOLD=required
  args:
    executable: /bin/bash
  environment:
    OS_CLOUD: system
  register: _ironic_prepare_node
  changed_when: _ironic_prepare_node.rc == 0
  failed_when: _ironic_prepare_node.rc != 0
