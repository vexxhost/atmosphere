# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
- name: Deploy Sushy (Redfish emulator) service
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          namespace: openstack
          name: sushy-config
        data:
          emulator.config: |
            SUSHY_EMULATOR_BOOT_LOADER_MAP = {
                'UEFI': {
                    'x86_64': '/var/lib/libvirt/images/OVMF_CODE_4M.fd'
                },
                'Legacy': {
                    'x86_64': None
                }
            }
            SUSHY_EMULATOR_FEATURE_SET = "full"

- name: Deploy Sushy (Redfish emulator) service
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVersion: apps/v1
        kind: DaemonSet
        metadata:
          name: sushy
          namespace: openstack
          labels:
            application: sushy
        spec:
          selector:
            matchLabels:
              application: sushy
          template:
            metadata:
              labels:
                application: sushy
            spec:
              nodeSelector:
                openstack-control-plane: enabled
              hostNetwork: true
              hostPID: true
              hostIPC: true
              dnsPolicy: ClusterFirstWithHostNet
              containers:
                - name: build-emulation-vms
                  image: "{{ atmosphere_images['sushy'] | vexxhost.kubernetes.docker_image('ref') }}"
                  securityContext:
                    privileged: true
                    readOnlyRootFilesystem: false
                  env:
                    - name: DEPENDENCY_SERVICE
                      value: openstack:nova-api
                    - name: DEPENDENCY_DAEMONSET
                      value: openstack:libvirt
                  command: ["/bin/sh", "-c", "cat /etc/ironic/redfish/emulator.conf"]
                  volumeMounts:
                    - name: config-sushy
                      mountPath: /etc/ironic/redfish/emulator.conf
                      subPath: emulator.config
                    - name: pod-tmp
                      mountPath: /tmp
                    - name: libvirt-etc
                      mountPath: /etc/libvirt/qemu.conf
                      subPath: qemu.conf
                      readOnly: true
                    - name: etc-libvirt-qemu
                      mountPath: /etc/libvirt/qemu
                    - mountPath: /lib/modules
                      name: libmodules
                      readOnly: true
                    - name: var-lib-libvirt
                      mountPath: /var/lib/libvirt
                      mountPropagation: Bidirectional
                    - name: var-lib-nova
                      mountPath: /var/lib/nova
                      mountPropagation: Bidirectional
                    - name: run
                      mountPath: /run
                    - name: dev
                      mountPath: /dev
                    - name: cgroup
                      mountPath: /sys/fs/cgroup
                    - name: logs
                      mountPath: /var/log/libvirt
                    - name: machine-id
                      mountPath: /etc/machine-id
                      readOnly: true
                - name: sushy
                  image: "{{ atmosphere_images['sushy'] | vexxhost.kubernetes.docker_image('ref') }}"
                  securityContext:
                    privileged: true
                    readOnlyRootFilesystem: false
                  readinessProbe:
                    failureThreshold: 3
                    httpGet:
                      path: /
                      port: 9132
                      scheme: HTTP
                  livenessProbe:
                    failureThreshold: 3
                    httpGet:
                      path: /
                      port: 9132
                      scheme: HTTP
                    periodSeconds: 10
                    successThreshold: 1
                    timeoutSeconds: 1
                  command:
                    - /bin/bash
                    - -c
                    - gunicorn sushy_tools.emulator.main:app --bind "{{ ansible_facts['default_ipv4'].address }}":9132 --env FLASK_DEBUG=1 --env SUSHY_EMULATOR_CONFIG=/etc/ironic/redfish/emulator.conf --workers 2 --threads 2 --timeout 90
                  volumeMounts:
                    - name: config-sushy
                      mountPath: /etc/ironic/redfish/emulator.conf
                      subPath: emulator.config
                    - name: pod-tmp
                      mountPath: /tmp
                    - name: libvirt-etc
                      mountPath: /etc/libvirt/qemu.conf
                      subPath: qemu.conf
                      readOnly: true
                    - name: etc-libvirt-qemu
                      mountPath: /etc/libvirt/qemu
                    - mountPath: /lib/modules
                      name: libmodules
                      readOnly: true
                    - name: var-lib-libvirt
                      mountPath: /var/lib/libvirt
                      mountPropagation: Bidirectional
                    - name: var-lib-nova
                      mountPath: /var/lib/nova
                      mountPropagation: Bidirectional
                    - name: run
                      mountPath: /run
                    - name: dev
                      mountPath: /dev
                    - name: cgroup
                      mountPath: /sys/fs/cgroup
                    - name: logs
                      mountPath: /var/log/libvirt
                    - name: machine-id
                      mountPath: /etc/machine-id
                      readOnly: true
              volumes:
                - name: config-sushy
                  configMap:
                    name: sushy-config
                - name: pod-tmp
                  emptyDir: {}
                - name: libvirt-etc
                  secret:
                    secretName: libvirt-libvirt-default-etc
                    defaultMode: 0444
                - name: libmodules
                  hostPath:
                    path: /lib/modules
                - name: var-lib-libvirt
                  hostPath:
                    path: /var/lib/libvirt
                - name: var-lib-nova
                  hostPath:
                    path: /var/lib/nova
                - name: run
                  hostPath:
                    path: /run
                - name: run-libvirt
                  hostPath:
                    path: /run/libvirt
                - name: dev
                  hostPath:
                    path: /dev
                - name: logs
                  hostPath:
                    path: /var/log/libvirt
                - name: cgroup
                  hostPath:
                    path: /sys/fs/cgroup
                - name: machine-id
                  hostPath:
                    path: /etc/machine-id
                - name: etc-libvirt-qemu
                  hostPath:
                    path: /etc/libvirt/qemu
                - name: etc-modprobe-d
                  hostPath:
                    path: /etc/modprobe.d
                - name: host-rootfs
                  hostPath:
                    path: /
                    type: Directory
