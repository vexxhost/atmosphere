From b1bed8b07e7c85dbcce3bbc0cb00a1135d429664 Mon Sep 17 00:00:00 2001
From: ricolin <rlin@vexxhost.com>
Date: Fri, 9 May 2025 08:53:02 +0800
Subject: [PATCH] Enable {priority,runtime}ClassName for designate

ref: https://review.opendev.org/c/openstack/openstack-helm/+/949301

Change-Id: I1de5f4998451154329ffd5c974d9db2dbf7d16bc
---
 designate/templates/deployment-api.yaml          |  6 ++++++
 designate/templates/deployment-central.yaml      |  6 ++++++
 designate/templates/deployment-mdns.yaml         |  6 ++++++
 designate/templates/deployment-producer.yaml     |  6 ++++++
 designate/templates/deployment-sink.yaml         |  6 ++++++
 designate/templates/deployment-worker.yaml       |  6 ++++++
 designate/values.yaml                            | 16 ++++++++++++++++
 .../notes/designate-6f036f402f79e46c.yaml        |  7 +++++++
 8 files changed, 59 insertions(+)
 create mode 100644 releasenotes/notes/designate-6f036f402f79e46c.yaml

diff --git a/designate/templates/deployment-api.yaml b/designate/templates/deployment-api.yaml
index 2bb051e44..a56be9549 100644
--- a/designate/templates/deployment-api.yaml
+++ b/designate/templates/deployment-api.yaml
@@ -42,6 +42,12 @@ spec:
         configmap-etc-hash: {{ tuple "configmap-etc.yaml" . | include "helm-toolkit.utils.hash" }}
 {{ tuple "designate_api" . | include "helm-toolkit.snippets.custom_pod_annotations" | indent 8 }}
     spec:
+{{ with .Values.pod.priorityClassName.designate_api }}
+      priorityClassName: {{ . }}
+{{ end }}
+{{ with .Values.pod.runtimeClassName.designate_api }}
+      runtimeClassName: {{ . }}
+{{ end }}
       serviceAccountName: {{ $serviceAccountName }}
 {{ dict "envAll" $envAll "application" "designate" | include "helm-toolkit.snippets.kubernetes_pod_security_context" | indent 6 }}
       affinity:
diff --git a/designate/templates/deployment-central.yaml b/designate/templates/deployment-central.yaml
index abc6f0384..14aa0d931 100644
--- a/designate/templates/deployment-central.yaml
+++ b/designate/templates/deployment-central.yaml
@@ -42,6 +42,12 @@ spec:
         configmap-etc-hash: {{ tuple "configmap-etc.yaml" . | include "helm-toolkit.utils.hash" }}
 {{ tuple "designate_central" . | include "helm-toolkit.snippets.custom_pod_annotations" | indent 8 }}
     spec:
+{{ with .Values.pod.priorityClassName.designate_central }}
+      priorityClassName: {{ . }}
+{{ end }}
+{{ with .Values.pod.runtimeClassName.designate_central }}
+      runtimeClassName: {{ . }}
+{{ end }}
       serviceAccountName: {{ $serviceAccountName }}
       affinity:
 {{ tuple $envAll "designate" "central" | include "helm-toolkit.snippets.kubernetes_pod_anti_affinity" | indent 8 }}
diff --git a/designate/templates/deployment-mdns.yaml b/designate/templates/deployment-mdns.yaml
index 0463d0e22..c8b2e87f7 100644
--- a/designate/templates/deployment-mdns.yaml
+++ b/designate/templates/deployment-mdns.yaml
@@ -42,6 +42,12 @@ spec:
         configmap-etc-hash: {{ tuple "configmap-etc.yaml" . | include "helm-toolkit.utils.hash" }}
 {{ tuple "designate_mdns" . | include "helm-toolkit.snippets.custom_pod_annotations" | indent 8 }}
     spec:
+{{ with .Values.pod.priorityClassName.designate_mdns }}
+      priorityClassName: {{ . }}
+{{ end }}
+{{ with .Values.pod.runtimeClassName.designate_mdns }}
+      runtimeClassName: {{ . }}
+{{ end }}
       serviceAccountName: {{ $serviceAccountName }}
 {{ dict "envAll" $envAll "application" "designate" | include "helm-toolkit.snippets.kubernetes_pod_security_context" | indent 6 }}
       affinity:
diff --git a/designate/templates/deployment-producer.yaml b/designate/templates/deployment-producer.yaml
index 9b2cc3299..48be692de 100644
--- a/designate/templates/deployment-producer.yaml
+++ b/designate/templates/deployment-producer.yaml
@@ -42,6 +42,12 @@ spec:
         configmap-etc-hash: {{ tuple "configmap-etc.yaml" . | include "helm-toolkit.utils.hash" }}
 {{ tuple "designate_producer" . | include "helm-toolkit.snippets.custom_pod_annotations" | indent 8 }}
     spec:
+{{ with .Values.pod.priorityClassName.designate_producer }}
+      priorityClassName: {{ . }}
+{{ end }}
+{{ with .Values.pod.runtimeClassName.designate_producer }}
+      runtimeClassName: {{ . }}
+{{ end }}
       serviceAccountName: {{ $serviceAccountName }}
       affinity:
 {{ tuple $envAll "designate" "producer" | include "helm-toolkit.snippets.kubernetes_pod_anti_affinity" | indent 8 }}
diff --git a/designate/templates/deployment-sink.yaml b/designate/templates/deployment-sink.yaml
index 8844fa10c..c63f25d4d 100644
--- a/designate/templates/deployment-sink.yaml
+++ b/designate/templates/deployment-sink.yaml
@@ -42,6 +42,12 @@ spec:
         configmap-etc-hash: {{ tuple "configmap-etc.yaml" . | include "helm-toolkit.utils.hash" }}
 {{ tuple "designate_sink" . | include "helm-toolkit.snippets.custom_pod_annotations" | indent 8 }}
     spec:
+{{ with .Values.pod.priorityClassName.designate_sink }}
+      priorityClassName: {{ . }}
+{{ end }}
+{{ with .Values.pod.runtimeClassName.designate_sink }}
+      runtimeClassName: {{ . }}
+{{ end }}
       serviceAccountName: {{ $serviceAccountName }}
       affinity:
 {{ tuple $envAll "designate" "sink" | include "helm-toolkit.snippets.kubernetes_pod_anti_affinity" | indent 8 }}
diff --git a/designate/templates/deployment-worker.yaml b/designate/templates/deployment-worker.yaml
index 2ada427e3..a1e7c91c5 100644
--- a/designate/templates/deployment-worker.yaml
+++ b/designate/templates/deployment-worker.yaml
@@ -42,6 +42,12 @@ spec:
         configmap-etc-hash: {{ tuple "configmap-etc.yaml" . | include "helm-toolkit.utils.hash" }}
 {{ tuple "designate_worker" . | include "helm-toolkit.snippets.custom_pod_annotations" | indent 8 }}
     spec:
+{{ with .Values.pod.priorityClassName.designate_worker }}
+      priorityClassName: {{ . }}
+{{ end }}
+{{ with .Values.pod.runtimeClassName.designate_worker }}
+      runtimeClassName: {{ . }}
+{{ end }}
       serviceAccountName: {{ $serviceAccountName }}
       affinity:
 {{ tuple $envAll "designate" "worker" | include "helm-toolkit.snippets.kubernetes_pod_anti_affinity" | indent 8 }}
diff --git a/designate/values.yaml b/designate/values.yaml
index be9d7e572..2850fd33c 100644
--- a/designate/values.yaml
+++ b/designate/values.yaml
@@ -66,6 +66,22 @@ images:
       - image_repo_sync
 
 pod:
+  priorityClassName:
+    designate_api: null
+    designate_central: null
+    designate_mdns: null
+    designate_producer: null
+    designate_sink: null
+    designate_worker: null
+    db_sync: null
+  runtimeClassName:
+    designate_api: null
+    designate_central: null
+    designate_mdns: null
+    designate_producer: null
+    designate_sink: null
+    designate_worker: null
+    db_sync: null
   affinity:
     anti:
       type:
diff --git a/releasenotes/notes/designate-6f036f402f79e46c.yaml b/releasenotes/notes/designate-6f036f402f79e46c.yaml
new file mode 100644
index 000000000..61b02f361
--- /dev/null
+++ b/releasenotes/notes/designate-6f036f402f79e46c.yaml
@@ -0,0 +1,7 @@
+---
+designate:
+  - |
+    Add support for {priority,runtime}ClassName for designate.
+    This provides a balance of performance versus security.
+    So as better prioritize between pods.
+...
-- 
2.25.1

